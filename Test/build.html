<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  <title>MD/TXT 文件清单生成器</title>
  <meta name="description" content="MD/TXT 文件清单生成器" />
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <header class="header">
    <div class="container">
      <nav class="nav" aria-label="主导航">
        <div class="back-home">
          <a href="/index.html" class="back-button">← 返回首页</a>
        </div>
      </nav>
    </div>
  </header>

  <main class="main">
    <div class="container">
      <div class="profile" id="home">
        <div class="profile-content">
          <h1>MD/TXT 文件清单生成器</h1>
          <p class="description">选择包含 .md 或 .txt 文件的文件夹，生成 manifest.js 文件</p>

          <div class="profile-actions">
            <button id="selectFolderBtn" class="btn btn-primary">选择文件夹</button>
            <button id="downloadBtn" class="btn btn-secondary hidden">下载 manifest.js</button>
          </div>
        </div>
      </div>

      <div class="content">
        <section class="content-section" id="status">
          <h2>状态</h2>
          <p id="statusText">等待操作...</p>
        </section>
      </div>
    </div>
  </main>

  <script src="../script.js"></script>
  
  <script>
    // 全局变量
    let filesManifest = {};
    let selectedFolder = null;
    
    // DOM 元素
    const selectFolderBtn = document.getElementById('selectFolderBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusText = document.getElementById('statusText');
    
    // 选择文件夹
    selectFolderBtn.addEventListener('click', async () => {
      try {
        // 重置状态
        resetUI();
        
        // 选择文件夹
        selectedFolder = await window.showDirectoryPicker();
        statusText.textContent = '正在扫描文件...';
        
        // 扫描文件夹
        await scanFolder(selectedFolder);
        
        // 生成 manifest
        generateManifest();
        
        // 显示下载按钮
        downloadBtn.classList.remove('hidden');
        
        statusText.textContent = `✅ 已扫描 ${Object.keys(filesManifest).length} 个文件，可以下载`;
        
      } catch (error) {
        if (error.name !== 'AbortError') {
          statusText.textContent = '❌ 出错: ' + error.message;
        }
      }
    });
    
    // 下载按钮
    downloadBtn.addEventListener('click', () => {
      downloadManifest();
    });
    
    // 扫描文件夹
    async function scanFolder(directoryHandle, basePath = '') {
      for await (const entry of directoryHandle.values()) {
        if (entry.kind === 'file') {
          const fileName = entry.name;
          const fileExtension = fileName.toLowerCase().split('.').pop();
          
          // 只处理 .md 和 .txt 文件
          if (fileExtension === 'md' || fileExtension === 'txt') {
            // --- 关键修改：移除文件后缀名 ---
            // 获取不带扩展名的文件名部分。+ 1 是为了移除前面的点 (e.g., .md)
            const baseName = fileName.slice(0, -(fileExtension.length + 1)); 
            // 构造新的相对路径作为 manifest 的 key
            const relativePath = basePath ? `${basePath}/${baseName}` : baseName; 
            // ---------------------------------
            
            try {
              const file = await entry.getFile();
              const text = await file.text();
              filesManifest[relativePath] = text; // 使用不带扩展名的 relativePath 作为 key
            } catch (error) {
              console.error(`读取文件 ${fileName} 时出错:`, error);
            }
          }
        } else if (entry.kind === 'directory') {
          await scanFolder(entry, basePath ? `${basePath}/${entry.name}` : entry.name);
        }
      }
    }
    
    // 生成 manifest
    function generateManifest() {
      const manifest = {};
      for (const filePath in filesManifest) {
        // 确保路径分隔符是正斜杠
        const normalizedPath = filePath.replace(/\\/g, '/'); 
        manifest[normalizedPath] = filesManifest[filePath];
      }
      
      const jsContent = `window.filesManifest = ${JSON.stringify(manifest, null, 2)};`;
      downloadBtn.dataset.content = jsContent;
    }
    
    // 下载 manifest.js
    function downloadManifest() {
      const content = downloadBtn.dataset.content;
      if (!content) return;
      
      const blob = new Blob([content], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'manifest.js';
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      
      statusText.textContent = '✅ manifest.js 已开始下载';
    }
    
    // 重置UI
    function resetUI() {
      filesManifest = {};
      downloadBtn.classList.add('hidden');
      statusText.textContent = '等待操作...';
    }
    
    // 添加hidden样式
    const style = document.createElement('style');
    style.textContent = '.hidden { display: none !important; }';
    document.head.appendChild(style);
    
    // 浏览器兼容性检查
    if (!window.showDirectoryPicker) {
      statusText.textContent = '⚠️ 您的浏览器不支持文件夹选择功能';
      selectFolderBtn.disabled = true;
    }
  </script>
</body>
</html>